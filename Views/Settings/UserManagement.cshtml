@{
    ViewData["Title"] = "User Management";
}

<h4>User Management</h4>

<!-- Main Card Container -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <strong>User Management</strong>
                    <span class="small ms-1 text-muted">Manage users, roles, and data access</span>
                </div>
            </div>
            <div class="card-body">
                <!-- Action Buttons -->
                <div class="mb-3">
                    <button type="button" class="btn btn-core-inverse" id="btnAddUser">
                        <i class="fa-solid fa-user-plus"></i> Add New User
                    </button>
                    <button type="button" class="btn btn-core-inverse" id="btnRefresh">
                        <i class="fa-solid fa-refresh"></i> Refresh
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label small">Role</label>
                        <select class="form-select form-select-sm" id="filterRole">
                            <option value="">All Roles</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Status</label>
                        <select class="form-select form-select-sm" id="filterStatus">
                            <option value="">All Status</option>
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Auth Type</label>
                        <select class="form-select form-select-sm" id="filterAuthType">
                            <option value="">All Types</option>
                            <option value="AD">Active Directory</option>
                            <option value="DB">Database</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">&nbsp;</label>
                        <button type="button" class="btn btn-core-secondary-inverse btn-sm d-block" id="btnClearFilter">
                            <i class="fa-solid fa-filter-circle-xmark"></i> Clear Filters
                        </button>
                    </div>
                </div>

                <!-- AG Grid Container -->
                <div class="position-relative mt-4">
                    <div class="grid-container" id="userGridContainer">
                        <button type="button" id="btnExportExcel" class="export-excel-btn" title="Export to Excel">
                            <i class="fa-regular fa-file-excel export-icon"></i>
                        </button>
                        <button class="fullscreen-toggle-btn" id="btnToggleFullscreen" title="Toggle Fullscreen">
                            <i class="fa-solid fa-expand"></i>
                        </button>
                        <div id="userGrid" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>
                        <div id="gridLoadingSpinner" class="position-absolute top-50 start-50 translate-middle d-none">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm text-primary mb-2" role="status" style="width: 2rem; height: 2rem;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="text-muted">Loading users...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- User Form Offcanvas (Right Side) -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="userFormOffcanvas" aria-labelledby="userFormOffcanvasLabel" data-bs-backdrop="static" data-bs-keyboard="false" style="width: 600px;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="userFormOffcanvasLabel">
            <i class="fa-solid fa-user-plus me-2"></i>
            <span id="formTitleText">Add User</span>
        </h5>
        <button type="button" class="btn-close" aria-label="Close" id="closeUserFormBtn"></button>
    </div>
    <div class="offcanvas-body">
        <form id="userForm" novalidate>
            <input type="hidden" id="userId" name="userId" value="0">

            <!-- Nav Tabs -->
            <ul class="nav nav-tabs mb-3" id="userFormTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basicTab" type="button" role="tab">
                        <i class="fa-solid fa-user me-1"></i> Basic Info
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="roles-tab" data-bs-toggle="tab" data-bs-target="#rolesTab" type="button" role="tab">
                        <i class="fa-solid fa-user-tag me-1"></i> Roles
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="access-tab" data-bs-toggle="tab" data-bs-target="#accessTab" type="button" role="tab">
                        <i class="fa-solid fa-shield me-1"></i> Data Access
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="userFormTabContent">
                <!-- Basic Info Tab -->
                <div class="tab-pane fade show active" id="basicTab" role="tabpanel">
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="username" name="username" required>
                            <div class="invalid-feedback">Username is required</div>
                        </div>
                        <div class="col-6">
                            <label for="empCode" class="form-label">Employee Code</label>
                            <input type="text" class="form-control form-control-sm" id="empCode" name="empCode">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="displayName" class="form-label">Display Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="displayName" name="displayName" required>
                            <div class="invalid-feedback">Display Name is required</div>
                        </div>
                        <div class="col-6">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control form-control-sm" id="email" name="email">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="authType" class="form-label">Auth Type <span class="text-danger">*</span></label>
                            <select class="form-select form-select-sm" id="authType" name="authType" required>
                                <option value="AD">Active Directory</option>
                                <option value="DB">Database</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label for="companyId" class="form-label">Company</label>
                            <select class="form-select form-select-sm" id="companyId" name="companyId">
                                <option value="">-- Select Company --</option>
                            </select>
                        </div>
                    </div>
                    <!-- Password fields (for DB auth only) -->
                    <div id="passwordSection" class="d-none">
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="password" class="form-label">Password <span class="text-danger" id="pwdRequired">*</span></label>
                                <input type="password" class="form-control form-control-sm" id="password" name="password">
                                <div class="invalid-feedback">Password is required for DB authentication</div>
                            </div>
                            <div class="col-6">
                                <label for="confirmPassword" class="form-label">Confirm Password <span class="text-danger" id="confirmPwdRequired">*</span></label>
                                <input type="password" class="form-control form-control-sm" id="confirmPassword" name="confirmPassword">
                                <div class="invalid-feedback">Passwords do not match</div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActive" name="isActive" checked>
                                <label class="form-check-label" for="isActive">Active</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Roles Tab -->
                <div class="tab-pane fade" id="rolesTab" role="tabpanel">
                    <div class="alert alert-info small mb-3">
                        <i class="fa-solid fa-info-circle me-1"></i>
                        Assign one or more roles to this user. Roles determine what the user can access.
                    </div>
                    <div id="roleCheckboxList" class="row g-2">
                        <!-- Role checkboxes will be generated here -->
                    </div>
                </div>

                <!-- Data Access Tab -->
                <div class="tab-pane fade" id="accessTab" role="tabpanel">
                    <div class="alert alert-info small mb-3">
                        <i class="fa-solid fa-info-circle me-1"></i>
                        Define data access permissions. This controls which data the user can view or edit.
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-core-inverse btn-sm" id="btnAddDataAccess">
                            <i class="fa-solid fa-plus"></i> Add Access Rule
                        </button>
                    </div>

                    <!-- Data Access Grid -->
                    <div id="dataAccessGrid" class="ag-theme-alpine" style="height: 250px; width: 100%;"></div>
                </div>
            </div>

            <!-- Form Buttons -->
            <div class="mt-4 pt-3 border-top d-flex gap-2">
                <button type="button" class="btn btn-core-secondary-inverse flex-fill" id="cancelUserBtn">
                    <i class="fa-solid fa-times"></i> Cancel
                </button>
                <button type="submit" class="btn btn-core flex-fill" id="btnSaveUser">
                    <span class="spinner-border spinner-border-sm d-none" id="saveSpinner"></span>
                    <span id="saveText"><i class="fa-solid fa-save"></i> Save User</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- Data Access Modal -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div class="modal fade" id="dataAccessModal" tabindex="-1" aria-labelledby="dataAccessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="dataAccessModalLabel">
                    <i class="fa-solid fa-shield-halved me-2"></i> Add Data Access Rule
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="dataAccessForm">
                    <input type="hidden" id="dataAccessId" value="0">
                    <div class="mb-3">
                        <label for="accessCompanyId" class="form-label">Company</label>
                        <select class="form-select form-select-sm" id="accessCompanyId">
                            <option value="">All Companies</option>
                        </select>
                        <div class="form-text">Leave empty for access to all companies</div>
                    </div>
                    <div class="mb-3">
                        <label for="accessCostCenterCode" class="form-label">Cost Center</label>
                        <select class="form-select form-select-sm" id="accessCostCenterCode">
                            <option value="">All Cost Centers</option>
                        </select>
                        <div class="form-text">Leave empty for access to all cost centers in selected company</div>
                    </div>
                    <div class="mb-3">
                        <label for="accessType" class="form-label">Access Type <span class="text-danger">*</span></label>
                        <select class="form-select form-select-sm" id="accessType" required>
                            <option value="VIEW_ONLY">View Only</option>
                            <option value="EDIT">Edit</option>
                            <option value="FULL">Full Access</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-core-secondary-inverse btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-core btn-sm" id="btnSaveDataAccess">
                    <i class="fa-solid fa-check"></i> Add Rule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- Password Reset Modal -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="resetPasswordModalLabel">
                    <i class="fa-solid fa-key me-2"></i> Reset Password
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="resetPasswordForm">
                    <input type="hidden" id="resetUserId" value="0">
                    <div class="alert alert-warning small">
                        <i class="fa-solid fa-exclamation-triangle me-1"></i>
                        This will reset the password for user: <strong id="resetUserName"></strong>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control form-control-sm" id="newPassword" required minlength="8">
                        <div class="form-text">Minimum 8 characters</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmNewPassword" class="form-label">Confirm New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control form-control-sm" id="confirmNewPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-core-secondary-inverse btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning btn-sm" id="btnResetPassword">
                    <i class="fa-solid fa-key"></i> Reset Password
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/xlsx/exceljs/exceljs.min.js"></script>
    <script src="~/lib/razor/js/settings/budget.setting.user.manage.js" asp-append-version="true"></script>
}
